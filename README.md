
# Телеграм-бот для новостных дайджестов

Простой бот, который позволяет подписаться на тикеры акций и получать по ним краткий обзор новостей.

## Требования
- Python 3.11 или новее
- файл `.env` c переменной `TELEGRAM_TOKEN`

## Возможности

- `/start` и `/help` — вывод подсказок
- `/subscribe <TICKER> [...]` и `/unsubscribe <TICKER>` — управление подписками
- `/subs` — показать текущие подписки
- `/digest` — получение новостного дайджеста по подписанным тикерам
- `/subscriptions` — показать текущие подписки
- `/news [hours|days|weeks N]` — свежие новости с AI‑саммари за указанный период
- `/csv` — скачать файл `articles.csv` с собранными новостями

### Портфель
- `/mybag` — показать портфель Тинькофф Инвест
- `/csvbag` — скачать ваш портфель в CSV
- `/chart` — диаграмма стоимости по тикерам портфеля
- `/history <TICKER> [days]` — график цены за период
- `/analysis` — AI-анализ вашего портфеля через Gemini

### Прочее
- `/start` и `/help` — вывод подсказок
- `/log` — показать последние строки лога

Подписки и токены хранятся в SQLite базе `bot/user_data.db`. В таблице `users`
хранится токен для каждого `user_id`, а в таблице `subscriptions` перечислены
тикеры пользователя. Таким образом каждый пользователь видит только свои тикеры.
Все найденные новости бот складывает в CSV‑файл `articles.csv` в каталоге `bot`.
Отдельный скрипт `bot/pg_collector.py` асинхронно собирает новости из RSS и
сохраняет их в базу PostgreSQL, указанную переменной окружения `DATABASE_URL`.
Команда `/news` выводит краткие AI‑саммари из таблицы `ai_news` этой базы,
а `/digest` обращается к RSS‑лентам только для ваших подписок.


База подписок и работа с CSV выполняются асинхронно, поэтому команды
`/news` и `/digest` не блокируют бота даже при длительном сборе новостей.

Во время сбора новостей бот может ответить, что запрос обрабатывается.
Тяжёлые операции выполняются в отдельном пуле потоков, а обработка
сообщений Telegram идёт параллельно благодаря включённому режиму
`concurrent_updates`. RSS‑ленты и тексты статей загружаются асинхронно,
поэтому несколько команд могут выполняться одновременно без задержек.

## Структура проекта
```
.
├── Dockerfile
├── README.md
├── requirements.txt
├── bot/
│   ├── __init__.py
│   ├── main.py
│   ├── rss_collector.py
│   └── storage.py
└── .env


Число потоков можно настроить переменной окружения `WORKERS`.
Для доступа к базе PostgreSQL укажите `DATABASE_URL`.

## Запуск в Docker
1. Создайте файл `.env` с переменной `TELEGRAM_TOKEN`.
2. Постройте образ:
   ```bash
   docker build -t telegram-digest-bot .
   ```
3. Запустите контейнер:

   ```bash
   docker run --env-file .env telegram-digest-bot
   ```

## Запуск без Docker
1. Создайте файл `.env` с переменной `TELEGRAM_TOKEN`.
2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
3. Запустите бота командой:
   ```bash
   python -m bot.main
   ```

При первом запуске будет создан файл `bot/user_data.db` с таблицами `users` и `subscriptions` для хранения токенов и подписок.


После запуска бот начнёт опрашивать Telegram и реагировать на команды пользователей.
Чтобы наполнять базу новостями, периодически запускайте:

```bash
python -m bot.pg_collector
```

## Ручной сбор новостей
Вы можете выгрузить свежие статьи без запуска телеграм-бота:

```bash
python -m bot.rss_collector
```

В каталоге появится файл `news_YYYY-MM-DD.csv` со всеми публикациями за день.

## Первичное заполнение базы
Чтобы разово загрузить новости за несколько последних дней и получить по ним
саммари через Gemini, запустите:

```bash
python -m bot.one_time_summary --days 10
```

По умолчанию собираются новости за 10 дней. Скрипт сохранит исходные статьи в
таблицу `news`, а результаты анализа — в `ai_news`.


